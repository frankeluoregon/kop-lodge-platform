---
import Base from "../../layouts/Base.astro";
import { getConfig, getPublishedPosts } from "../../lib/db";

const db = Astro.locals.runtime.env.DB;
const config = await getConfig(db);
const posts  = await getPublishedPosts(db, 20);

function fmtDate(d: string) {
  return new Date(d).toLocaleDateString("en-US", {
    month: "long", day: "numeric", year: "numeric",
  });
}
---

<Base config={config} title="Blog">
  <div class="hero">
    <h1>Lodge Blog</h1>
    <p>News, announcements, and stories from {config.lodge_name}</p>
  </div>
  <main>
    {posts.length === 0
      ? <p style="color:#666">No posts yet — check back soon.</p>
      : (
        <div style="display:flex;flex-direction:column;gap:1.5rem">
          {posts.map((post) => (
            <article class="card" style="flex-direction:row;gap:1.25rem;align-items:flex-start">
              <div style="flex:1">
                <h2 style="font-size:1.2rem">
                  <a href={`/blog/${post.slug}`}>{post.title}</a>
                </h2>
                {post.published_at && (
                  <p class="meta">{fmtDate(post.published_at)}{post.author ? ` · by ${post.author}` : ""}</p>
                )}
                {post.excerpt && <p style="margin-top:.5rem">{post.excerpt}</p>}
                <a class="cta" href={`/blog/${post.slug}`} style="margin-top:.75rem">Read post &rarr;</a>
              </div>
            </article>
          ))}
        </div>
      )
    }
  </main>
</Base>
