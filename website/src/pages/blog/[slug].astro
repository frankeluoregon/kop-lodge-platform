---
import Base from "../../layouts/Base.astro";
import { getConfig, getBlogPost } from "../../lib/db";
import { renderMarkdown } from "../../lib/markdown";

const { slug } = Astro.params;
const db = Astro.locals.runtime.env.DB;
const config = await getConfig(db);
const post = slug ? await getBlogPost(db, slug) : null;

if (!post) {
  return Astro.redirect("/blog", 302);
}

function fmtDate(d: string) {
  return new Date(d).toLocaleDateString("en-US", {
    weekday: "long", month: "long", day: "numeric", year: "numeric",
  });
}
---

<Base config={config} title={post.title} description={post.excerpt ?? undefined}>
  <div class="hero" style="padding:2rem 1.5rem">
    <h1 style="font-size:1.8rem">{post.title}</h1>
    {post.published_at && (
      <p style="margin-top:.5rem;font-size:.9rem;opacity:.8">
        {fmtDate(post.published_at)}{post.author ? ` Â· by ${post.author}` : ""}
      </p>
    )}
  </div>
  <main>
    <a href="/blog" style="font-family:sans-serif;font-size:.85rem;display:inline-block;margin-bottom:1.5rem">&larr; Back to Blog</a>
    <article class="prose" set:html={renderMarkdown(post.content)} />
  </main>
</Base>
