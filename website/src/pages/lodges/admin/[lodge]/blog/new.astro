---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug } from "../../../../../lib/db";
import BlogForm from "../../../../../components/admin/forms/BlogForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  try {
    const form = await Astro.request.formData();
    const title  = form.get("title")?.toString() ?? "";
    const slug   = (form.get("slug")?.toString() || title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, ""));
    const now    = new Date().toISOString();
    const publish = form.get("published") === "1";
    await env.DB.prepare(
      `INSERT INTO blog_posts (lodge_id, slug, title, content, excerpt, author, published, published_at, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
    ).bind(
      lodge.id, slug, title,
      form.get("content")?.toString() ?? "",
      form.get("excerpt")?.toString() || null,
      form.get("author")?.toString() || null,
      publish ? 1 : 0,
      publish ? now : null,
      now, now,
    ).run();
    return wantsJson
      ? Response.redirect(new URL(`/lodges/admin/${lodgeSlug}`, Astro.url), 302)
      : Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);
  } catch (e: unknown) {
    const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
    if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
  }
}
---

<AdminForm title="New Blog Post" lodgeSlug={lodgeSlug}>
  <BlogForm
    client:only="react"
    cancelUrl={`/lodges/admin/${lodgeSlug}`}
  />
</AdminForm>
