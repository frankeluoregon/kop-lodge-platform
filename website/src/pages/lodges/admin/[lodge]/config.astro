---
import AdminForm from "../../../../layouts/AdminForm.astro";
import { getLodgeBySlug, getConfig } from "../../../../lib/db";
import { isSiteAdmin, getSession, isAccessConfigured, DEV_SESSION } from "../../../../lib/auth";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

let session;
if (isAccessConfigured(env)) {
  session = await getSession(Astro.request, env);
} else {
  session = DEV_SESSION;
}

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

// Fetch current admin emails for this lodge
const adminRoles = await env.DB.prepare(
  "SELECT email FROM admin_roles WHERE role = ?"
).bind(`lodge:${lodge.slug}`).all<{ email: string }>();
let currentAdminEmails = adminRoles.results.map(r => r.email).join("\n");

let message = "";
let isError = false;
let adminMessage = "";
let adminIsError = false;

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();

  // Admin email management (separate action)
  if (form.get("_action") === "save_admins") {
    try {
      const emails = (form.get("admin_emails") as string || "")
        .split(/[\n,]+/).map(e => e.trim().toLowerCase()).filter(Boolean);
      const now = new Date().toISOString();
      await env.DB.prepare("DELETE FROM admin_roles WHERE role = ?").bind(`lodge:${lodge.slug}`).run();
      for (const email of emails) {
        await env.DB.prepare(
          "INSERT OR IGNORE INTO admin_roles (email, role, created_at) VALUES (?, ?, ?)"
        ).bind(email, `lodge:${lodge.slug}`, now).run();
      }
      currentAdminEmails = emails.join("\n");
      adminMessage = "Lodge admins updated.";
    } catch (e: unknown) {
      adminIsError = true;
      adminMessage = `Error: ${e instanceof Error ? e.message : String(e)}`;
    }
  } else {
  try {
    const fields = [
      "lodge_name","lodge_number","state","grand_domain","city",
      "meeting_schedule","meeting_location","phone","email",
      "facebook_url","instagram_url","twitter_url",
      "donation_url","grand_lodge_url","mailing_address",
      "primary_color","accent_color","tagline","founded_year"
    ];
    const toggles = [
      "show_history","show_membership","show_gallery","show_links",
      "show_newsletter","show_programs",
      "show_blog","show_events","show_officers","show_service"
    ];
    const now = new Date().toISOString();
    for (const key of fields) {
      const val = form.get(key)?.toString() ?? "";
      await env.DB.prepare(
        "INSERT INTO lodge_config (lodge_id,key,value,updated_at) VALUES (?,?,?,?) ON CONFLICT(lodge_id,key) DO UPDATE SET value=excluded.value,updated_at=excluded.updated_at"
      ).bind(lodge.id, key, val, now).run();
    }
    for (const key of toggles) {
      const val = form.get(key) === "1" ? "1" : "";
      await env.DB.prepare(
        "INSERT INTO lodge_config (lodge_id,key,value,updated_at) VALUES (?,?,?,?) ON CONFLICT(lodge_id,key) DO UPDATE SET value=excluded.value,updated_at=excluded.updated_at"
      ).bind(lodge.id, key, val, now).run();
    }
    message = "Settings saved successfully.";
  } catch (e: unknown) {
    isError = true;
    message = `Error: ${e instanceof Error ? e.message : String(e)}`;
  }
  } // end else
}

const config = await getConfig(env.DB, lodge.id);
---

<AdminForm title="Lodge Settings" lodgeSlug={lodgeSlug}>
  {message && <div class={isError ? "error-msg" : "success-msg"}>{message}</div>}
  <form method="POST">
    <div class="row">
      <div class="field">
        <label>Lodge Name</label>
        <input type="text" name="lodge_name" value={config.lodge_name} required />
      </div>
      <div class="field">
        <label>Lodge Number</label>
        <input type="text" name="lodge_number" value={config.lodge_number} />
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>State</label>
        <input type="text" name="state" value={config.state} />
      </div>
      <div class="field">
        <label>Grand Domain <span class="hint">(e.g. "Oregon")</span></label>
        <input type="text" name="grand_domain" value={config.grand_domain} />
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>City</label>
        <input type="text" name="city" value={config.city} />
      </div>
      <div class="field">
        <label>Founded Year</label>
        <input type="text" name="founded_year" value={config.founded_year} />
      </div>
    </div>
    <div class="field">
      <label>Tagline</label>
      <input type="text" name="tagline" value={config.tagline} />
    </div>
    <div class="field">
      <label>Meeting Schedule</label>
      <input type="text" name="meeting_schedule" value={config.meeting_schedule} placeholder="e.g. First and Third Monday, 7:00 PM" />
    </div>
    <div class="field">
      <label>Meeting Location / Address</label>
      <input type="text" name="meeting_location" value={config.meeting_location} />
    </div>
    <div class="row">
      <div class="field">
        <label>Phone</label>
        <input type="text" name="phone" value={config.phone} />
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" name="email" value={config.email} />
      </div>
    </div>
    <h3>Social & Links</h3>
    <div class="row">
      <div class="field">
        <label>Facebook URL</label>
        <input type="url" name="facebook_url" value={config.facebook_url} />
      </div>
      <div class="field">
        <label>Instagram URL</label>
        <input type="url" name="instagram_url" value={config.instagram_url} />
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>Twitter / X URL</label>
        <input type="url" name="twitter_url" value={config.twitter_url} />
      </div>
      <div class="field">
        <label>Donation URL</label>
        <input type="url" name="donation_url" value={config.donation_url} />
      </div>
    </div>
    <div class="field">
      <label>Grand Lodge URL</label>
      <input type="url" name="grand_lodge_url" value={config.grand_lodge_url} />
    </div>
    <div class="field">
      <label>Mailing Address</label>
      <input type="text" name="mailing_address" value={config.mailing_address} />
    </div>

    <h3>Appearance</h3>
    <div class="row">
      <div class="field">
        <label>Primary Color <span class="hint">(hex)</span></label>
        <input type="text" name="primary_color" value={config.primary_color} />
      </div>
      <div class="field">
        <label>Accent Color <span class="hint">(hex)</span></label>
        <input type="text" name="accent_color" value={config.accent_color} />
      </div>
    </div>

    <h3>Section Visibility</h3>
    <p class="hint">Check sections to show in your lodge's navigation. Uncheck to hide.</p>
    <div class="row">
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_events" value="1" checked={config.show_events !== ""} /> Events
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_officers" value="1" checked={config.show_officers !== ""} /> Officers
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_blog" value="1" checked={config.show_blog !== ""} /> Blog / News
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_service" value="1" checked={config.show_service !== ""} /> Community Service
        </label>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_history" value="1" checked={config.show_history === "1"} /> History
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_membership" value="1" checked={config.show_membership === "1"} /> Membership / Join
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_gallery" value="1" checked={config.show_gallery === "1"} /> Photo Gallery
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_links" value="1" checked={config.show_links === "1"} /> Links
        </label>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_newsletter" value="1" checked={config.show_newsletter === "1"} /> Newsletter
        </label>
      </div>
      <div class="field">
        <label class="checkbox-row">
          <input type="checkbox" name="show_programs" value="1" checked={config.show_programs === "1"} /> Programs
        </label>
      </div>
    </div>

    <div class="actions">
      <button type="submit" class="btn primary">Save Settings</button>
      <a href={`/lodges/admin/${lodgeSlug}`} class="btn secondary">Cancel</a>
    </div>
  </form>

  <hr style="margin: 1.75rem 0; border: none; border-top: 1px solid #ddd;" />

  <h2 style="font-size:1rem;margin-bottom:.75rem;color:var(--primary)">Lodge Administrators</h2>
  <p style="font-size:.83rem;color:#666;margin-bottom:.75rem">Emails listed here can access this lodge's admin panel. One per line or comma-separated. Changes replace all current lodge admins.</p>
  {adminMessage && <div class={adminIsError ? "error-msg" : "success-msg"}>{adminMessage}</div>}
  <form method="POST">
    <input type="hidden" name="_action" value="save_admins" />
    <div class="field">
      <textarea name="admin_emails" rows="5">{currentAdminEmails}</textarea>
    </div>
    <div class="actions">
      <button type="submit" class="btn primary">Update Admins</button>
    </div>
  </form>
</AdminForm>
