---
import AdminForm from "../../../../layouts/AdminForm.astro";
import { getLodgeBySlug, getConfig } from "../../../../lib/db";
import { isSiteAdmin, getSession, isAccessConfigured, DEV_SESSION } from "../../../../lib/auth";
import ConfigForm from "../../../../components/admin/forms/ConfigForm";
import AdminEmailsForm from "../../../../components/admin/forms/AdminEmailsForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

let session;
if (isAccessConfigured(env)) {
  session = await getSession(Astro.request, env);
} else {
  session = DEV_SESSION;
}

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

// Fetch current admin emails for this lodge
const adminRoles = await env.DB.prepare(
  "SELECT email FROM admin_roles WHERE role = ?"
).bind(`lodge:${lodge.slug}`).all<{ email: string }>();
const currentAdminEmails = adminRoles.results.map(r => r.email).join("\n");

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();

  // Admin email management (separate action)
  if (form.get("_action") === "save_admins") {
    try {
      const emails = (form.get("admin_emails") as string || "")
        .split(/[\n,]+/).map(e => e.trim().toLowerCase()).filter(Boolean);
      const now = new Date().toISOString();
      await env.DB.prepare("DELETE FROM admin_roles WHERE role = ?").bind(`lodge:${lodge.slug}`).run();
      for (const email of emails) {
        await env.DB.prepare(
          "INSERT OR IGNORE INTO admin_roles (email, role, created_at) VALUES (?, ?, ?)"
        ).bind(email, `lodge:${lodge.slug}`, now).run();
      }
      if (wantsJson) return new Response(JSON.stringify({ message: "Lodge admins updated." }), { headers: { "Content-Type": "application/json" } });
    } catch (e: unknown) {
      const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
      if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
  } else {
    try {
      const fields = [
        "lodge_name","lodge_number","state","grand_domain","city",
        "meeting_schedule","meeting_location","phone","email",
        "facebook_url","instagram_url","twitter_url",
        "donation_url","grand_lodge_url","mailing_address",
        "primary_color","accent_color","tagline","founded_year"
      ];
      const toggles = [
        "show_history","show_membership","show_gallery","show_links",
        "show_newsletter","show_programs",
        "show_blog","show_events","show_officers","show_service"
      ];
      const now = new Date().toISOString();
      for (const key of fields) {
        const val = form.get(key)?.toString() ?? "";
        await env.DB.prepare(
          "INSERT INTO lodge_config (lodge_id,key,value,updated_at) VALUES (?,?,?,?) ON CONFLICT(lodge_id,key) DO UPDATE SET value=excluded.value,updated_at=excluded.updated_at"
        ).bind(lodge.id, key, val, now).run();
      }
      for (const key of toggles) {
        const val = form.get(key) === "1" ? "1" : "";
        await env.DB.prepare(
          "INSERT INTO lodge_config (lodge_id,key,value,updated_at) VALUES (?,?,?,?) ON CONFLICT(lodge_id,key) DO UPDATE SET value=excluded.value,updated_at=excluded.updated_at"
        ).bind(lodge.id, key, val, now).run();
      }
      if (wantsJson) return new Response(JSON.stringify({ message: "Settings saved successfully." }), { headers: { "Content-Type": "application/json" } });
    } catch (e: unknown) {
      const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
      if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
  }
}

const config = await getConfig(env.DB, lodge.id);
---

<AdminForm title="Lodge Settings" lodgeSlug={lodgeSlug}>
  <ConfigForm
    client:only="react"
    cancelUrl={`/lodges/admin/${lodgeSlug}`}
    initialData={{
      lodge_name: config.lodge_name,
      lodge_number: config.lodge_number,
      state: config.state,
      grand_domain: config.grand_domain,
      city: config.city,
      founded_year: config.founded_year,
      tagline: config.tagline,
      meeting_schedule: config.meeting_schedule,
      meeting_location: config.meeting_location,
      phone: config.phone,
      email: config.email,
      facebook_url: config.facebook_url,
      instagram_url: config.instagram_url,
      twitter_url: config.twitter_url,
      donation_url: config.donation_url,
      grand_lodge_url: config.grand_lodge_url,
      mailing_address: config.mailing_address,
      primary_color: config.primary_color,
      accent_color: config.accent_color,
      show_events: config.show_events !== "",
      show_officers: config.show_officers !== "",
      show_blog: config.show_blog !== "",
      show_service: config.show_service !== "",
      show_history: config.show_history === "1",
      show_membership: config.show_membership === "1",
      show_gallery: config.show_gallery === "1",
      show_links: config.show_links === "1",
      show_newsletter: config.show_newsletter === "1",
      show_programs: config.show_programs === "1",
    }}
  />

  <hr style="margin: 1.75rem 0; border: none; border-top: 1px solid #ddd;" />

  <h2 style="font-size:1rem;margin-bottom:.75rem;color:var(--primary)">Lodge Administrators</h2>
  <p style="font-size:.83rem;color:#666;margin-bottom:.75rem">Emails listed here can access this lodge's admin panel. One per line or comma-separated. Changes replace all current lodge admins.</p>

  <AdminEmailsForm
    client:only="react"
    initialEmails={currentAdminEmails}
  />
</AdminForm>
