---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug, getMemberById } from "../../../../../lib/db";
import MemberForm from "../../../../../components/admin/forms/MemberForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const id = Number(new URL(Astro.request.url).searchParams.get("id"));
if (!id) return Astro.redirect(`/lodges/admin/${lodgeSlug}/members`, 302);

const member = await getMemberById(env.DB, id);
if (!member || member.lodge_id !== lodge.id) return Astro.redirect(`/lodges/admin/${lodgeSlug}/members`, 302);

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();
  if (form.get("_action") === "delete") {
    await env.DB.prepare("DELETE FROM lodge_members WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).run();
    return wantsJson
      ? Response.redirect(new URL(`/lodges/admin/${lodgeSlug}/members`, Astro.url), 302)
      : Astro.redirect(`/lodges/admin/${lodgeSlug}/members`, 302);
  }
  try {
    await env.DB.prepare(
      "UPDATE lodge_members SET name=?,email=?,phone=?,office=?,joined_date=?,active=?,notes=? WHERE id=? AND lodge_id=?"
    ).bind(
      (form.get("name") as string || "").trim(),
      (form.get("email") as string || "").trim() || null,
      (form.get("phone") as string || "").trim() || null,
      (form.get("office") as string || "").trim() || null,
      (form.get("joined_date") as string || "") || null,
      form.get("active") === "1" ? 1 : 0,
      (form.get("notes") as string || "").trim() || null,
      id, lodge.id,
    ).run();
    if (wantsJson) return new Response(JSON.stringify({ message: "Member updated." }), { headers: { "Content-Type": "application/json" } });
  } catch (e: unknown) {
    const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
    if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
  }
}
---

<AdminForm title="Edit Member" lodgeSlug={lodgeSlug}>
  <MemberForm
    client:only="react"
    cancelUrl={`/lodges/admin/${lodgeSlug}/members`}
    isEdit
    initialData={{
      name: member!.name,
      email: member!.email ?? "",
      phone: member!.phone ?? "",
      office: member!.office ?? "",
      joined_date: member!.joined_date ?? "",
      notes: member!.notes ?? "",
      active: !!member!.active,
    }}
  />
</AdminForm>
