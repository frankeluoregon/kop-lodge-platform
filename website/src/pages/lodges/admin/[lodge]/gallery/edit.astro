---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug } from "../../../../../lib/db";
import GalleryForm from "../../../../../components/admin/forms/GalleryForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const id = Number(new URL(Astro.request.url).searchParams.get("id"));
if (!id) return Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);

const entry = await env.DB.prepare("SELECT * FROM gallery_photos WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).first<Record<string, unknown>>();
if (!entry) return Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();
  if (form.get("_action") === "delete") {
    await env.DB.prepare("DELETE FROM gallery_photos WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).run();
    return wantsJson
      ? Response.redirect(new URL(`/lodges/admin/${lodgeSlug}`, Astro.url), 302)
      : Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);
  }
  try {
    let imageKey = form.get("image_key")?.toString() ?? "";

    const photo = form.get("photo");
    if (photo instanceof File && photo.size > 0) {
      const safeName = photo.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const r2Key = `gallery/${lodgeSlug}/${Date.now()}-${safeName}`;
      await env.MEDIA.put(r2Key, photo.stream(), {
        httpMetadata: { contentType: photo.type },
      });
      imageKey = env.MEDIA_PUBLIC_URL
        ? `${env.MEDIA_PUBLIC_URL.replace(/\/$/, "")}/${r2Key}`
        : r2Key;
    }

    await env.DB.prepare(
      "UPDATE gallery_photos SET image_key=?,caption=?,display_order=?,published=? WHERE id=? AND lodge_id=?"
    ).bind(
      imageKey,
      form.get("caption")?.toString() || null,
      Number(form.get("display_order") ?? 0),
      form.get("published") === "1" ? 1 : 0,
      id, lodge.id,
    ).run();
    const redirectUrl = `/lodges/admin/${lodgeSlug}`;
    if (wantsJson) return new Response(JSON.stringify({ message: "Photo updated.", redirect: redirectUrl }), { headers: { "Content-Type": "application/json" } });
  } catch (e: unknown) {
    const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
    if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
  }
}
---

<AdminForm title="Edit Gallery Photo" lodgeSlug={lodgeSlug}>
  <GalleryForm
    client:only="react"
    cancelUrl={`/lodges/admin/${lodgeSlug}`}
    isEdit
    initialData={{
      image_key: String(entry.image_key ?? ""),
      caption: String(entry.caption ?? ""),
      display_order: Number(entry.display_order ?? 0),
      published: Boolean(entry.published),
    }}
  />
</AdminForm>
