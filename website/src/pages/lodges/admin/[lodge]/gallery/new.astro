---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug } from "../../../../../lib/db";
import GalleryForm from "../../../../../components/admin/forms/GalleryForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  try {
    const form = await Astro.request.formData();
    let imageKey = form.get("image_key")?.toString() ?? "";

    const photo = form.get("photo");
    if (photo instanceof File && photo.size > 0) {
      const safeName = photo.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const r2Key = `gallery/${lodgeSlug}/${Date.now()}-${safeName}`;
      await env.MEDIA.put(r2Key, photo.stream(), {
        httpMetadata: { contentType: photo.type },
      });
      imageKey = env.MEDIA_PUBLIC_URL
        ? `${env.MEDIA_PUBLIC_URL.replace(/\/$/, "")}/${r2Key}`
        : r2Key;
    }

    await env.DB.prepare(
      "INSERT INTO gallery_photos (lodge_id, image_key, caption, display_order) VALUES (?,?,?,?)"
    ).bind(
      lodge.id,
      imageKey,
      form.get("caption")?.toString() || null,
      Number(form.get("display_order") ?? 0),
    ).run();

    const redirectUrl = `/lodges/admin/${lodgeSlug}`;
    if (wantsJson) {
      return new Response(JSON.stringify({ message: "Photo added.", redirect: redirectUrl }), {
        headers: { "Content-Type": "application/json" },
      });
    }
    return Astro.redirect(redirectUrl, 302);
  } catch (e: unknown) {
    const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
    if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
  }
}
---

<AdminForm title="New Gallery Photo" lodgeSlug={lodgeSlug}>
  <GalleryForm
    client:only="react"
    cancelUrl={`/lodges/admin/${lodgeSlug}`}
  />
</AdminForm>
