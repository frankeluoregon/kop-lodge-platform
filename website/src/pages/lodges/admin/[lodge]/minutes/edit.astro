---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug, getMinutesById } from "../../../../../lib/db";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const id = Number(new URL(Astro.request.url).searchParams.get("id"));
if (!id) return Astro.redirect(`/lodges/admin/${lodgeSlug}/minutes`, 302);

let minutes = await getMinutesById(env.DB, id);
if (!minutes || minutes.lodge_id !== lodge.id) return Astro.redirect(`/lodges/admin/${lodgeSlug}/minutes`, 302);

let message = "";
let isError = false;

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  if (form.get("_action") === "delete") {
    await env.DB.prepare("DELETE FROM meeting_minutes WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).run();
    return Astro.redirect(`/lodges/admin/${lodgeSlug}/minutes`, 302);
  }
  try {
    const meeting_date = (form.get("meeting_date") as string || "").trim();
    const content = (form.get("content") as string || "").trim();
    if (!meeting_date || !content) throw new Error("Meeting date and content are required.");
    await env.DB.prepare(
      "UPDATE meeting_minutes SET meeting_date=?,title=?,content=?,published=? WHERE id=? AND lodge_id=?"
    ).bind(
      meeting_date,
      (form.get("title") as string || "").trim() || null,
      content,
      form.get("published") === "1" ? 1 : 0,
      id, lodge.id,
    ).run();
    minutes = await getMinutesById(env.DB, id);
    message = "Minutes updated.";
  } catch (e: unknown) {
    isError = true;
    message = `Error: ${e instanceof Error ? e.message : String(e)}`;
  }
}
---

<AdminForm title="Edit Meeting Minutes" lodgeSlug={lodgeSlug}>
  {message && <div class={isError ? "error-msg" : "success-msg"}>{message}</div>}
  <form method="POST">
    <div class="row">
      <div class="field">
        <label>Meeting Date</label>
        <input type="date" name="meeting_date" value={minutes!.meeting_date} required />
      </div>
      <div class="field">
        <label>Title <span class="hint">optional</span></label>
        <input type="text" name="title" value={minutes!.title ?? ""} placeholder="e.g. Regular Meeting" />
      </div>
    </div>
    <div class="field">
      <label>Minutes Content <span class="hint">Markdown supported</span></label>
      <textarea name="content" rows="14" required style="width:100%;padding:.55rem .75rem;border:1.5px solid #ccc;border-radius:5px;font-size:.9rem;font-family:inherit;background:#fff;resize:vertical;font-family:monospace">{minutes!.content}</textarea>
    </div>
    <div class="field">
      <label class="checkbox-row">
        <input type="checkbox" name="published" value="1" checked={!!minutes!.published} /> Visible to lodge admins
      </label>
    </div>
    <div class="actions">
      <button type="submit" class="btn primary">Save Changes</button>
      <a href={`/lodges/admin/${lodgeSlug}/minutes`} class="btn secondary">Cancel</a>
      <button type="submit" name="_action" value="delete" class="btn danger" onclick="return confirm('Delete these minutes?')">Delete</button>
    </div>
  </form>
</AdminForm>
