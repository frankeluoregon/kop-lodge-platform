---
import AdminForm from "../../../../../layouts/AdminForm.astro";
import { getLodgeBySlug } from "../../../../../lib/db";
import EventForm from "../../../../../components/admin/forms/EventForm";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const id = Number(new URL(Astro.request.url).searchParams.get("id"));
if (!id) return Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);

const event = await env.DB.prepare("SELECT * FROM events WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).first<Record<string, unknown>>();
if (!event) return Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();
  const action = form.get("_action");

  if (action === "delete") {
    await env.DB.prepare("DELETE FROM events WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).run();
    return wantsJson
      ? Response.redirect(new URL(`/lodges/admin/${lodgeSlug}`, Astro.url), 302)
      : Astro.redirect(`/lodges/admin/${lodgeSlug}`, 302);
  }

  try {
    const now = new Date().toISOString();
    const recurring = form.get("recurring") === "1" ? 1 : 0;
    const recurType = recurring ? (form.get("recur_type")?.toString() || null) : null;
    await env.DB.prepare(
      `UPDATE events SET title=?,event_date=?,level=?,description=?,end_date=?,location=?,url=?,published=?,recurring=?,recur_type=?,recur_day=?,recur_nth=?,recur_weekday=?,recur_end_date=?,updated_at=? WHERE id=? AND lodge_id=?`
    ).bind(
      form.get("title")?.toString() ?? "",
      form.get("event_date")?.toString() ?? "",
      form.get("level")?.toString() ?? "lodge",
      form.get("description")?.toString() || null,
      form.get("end_date")?.toString() || null,
      form.get("location")?.toString() || null,
      form.get("url")?.toString() || null,
      form.get("published") === "1" ? 1 : 0,
      recurring,
      recurType,
      recurring && recurType === "weekly"      ? Number(form.get("recur_day"))     : (recurring && recurType === "monthly-day" ? Number(form.get("recur_day")) : null),
      recurring && recurType === "monthly-nth" ? Number(form.get("recur_nth"))     : null,
      recurring && recurType === "monthly-nth" ? Number(form.get("recur_weekday")) : (recurring && recurType === "weekly" ? Number(form.get("recur_weekday")) : null),
      recurring ? (form.get("recur_end_date")?.toString() || null) : null,
      now, id, lodge.id,
    ).run();
    if (wantsJson) return new Response(JSON.stringify({ message: "Event updated." }), { headers: { "Content-Type": "application/json" } });
  } catch (e: unknown) {
    const msg = `Error: ${e instanceof Error ? e.message : String(e)}`;
    if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
  }
}
---

<AdminForm title="Edit Event" lodgeSlug={lodgeSlug}>
  <EventForm
    client:load
    cancelUrl={`/lodges/admin/${lodgeSlug}`}
    isEdit
    initialData={{
      title: String(event.title ?? ""),
      event_date: String(event.event_date ?? ""),
      end_date: String(event.end_date ?? ""),
      level: String(event.level ?? "lodge"),
      location: String(event.location ?? ""),
      description: String(event.description ?? ""),
      url: String(event.url ?? ""),
      published: Boolean(event.published),
      recurring: Boolean(event.recurring),
      recur_type: String(event.recur_type ?? "weekly"),
      recur_day: event.recur_day != null ? Number(event.recur_day) : null,
      recur_nth: event.recur_nth != null ? Number(event.recur_nth) : null,
      recur_weekday: event.recur_weekday != null ? Number(event.recur_weekday) : null,
      recur_end_date: String(event.recur_end_date ?? ""),
    }}
  />
</AdminForm>
