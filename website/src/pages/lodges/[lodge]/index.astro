---
import Base from "../../../layouts/Base.astro";
import { getLodgeBySlug, getConfig, getUpcomingEvents, getPublishedPosts, getCommunityService } from "../../../lib/db";
import { renderMarkdown } from "../../../lib/markdown";

const lodgeSlug = Astro.params.lodge!;
const db = Astro.locals.runtime.env.DB;

const lodge = await getLodgeBySlug(db, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const config  = await getConfig(db, lodge.id);
const events  = await getUpcomingEvents(db, lodge.id, undefined, 3);
const posts   = await getPublishedPosts(db, lodge.id, 3);
const featured = await getCommunityService(db, lodge.id, true, 3);

const base = `/lodges/${lodgeSlug}`;

function fmtDate(d: string) {
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {
    weekday: "short", month: "long", day: "numeric", year: "numeric",
  });
}

const levelLabel: Record<string, string> = {
  lodge: "Lodge Event", grand: "Grand Lodge", supreme: "Supreme Lodge",
};
---

<Base config={config} lodgeSlug={lodgeSlug}>
  <div class="hero">
    <img src="/seal.png" alt="KoP Seal" class="hero-seal" />
    <h1>{config.lodge_name}</h1>
    {config.tagline && <p>{config.tagline}</p>}
    {config.founded_year && <p style="margin-top:.5rem;font-size:.9rem;opacity:.7">Founded {config.founded_year}</p>}
  </div>
  <main>
    {events.length > 0 && (
      <section>
        <h2 class="section-heading"><span class="tri-accent"><img src="/bluetri.svg" alt="" /><img src="/redtri.svg" alt="" /><img src="/yeltri.svg" alt="" /></span> Upcoming Events</h2>
        <div class="card-grid">
          {events.map((ev) => (
            <div class="card">
              <span class="tag">{levelLabel[ev.level] ?? ev.level}</span>
              <h3>{ev.title}</h3>
              <p class="meta">{fmtDate(ev.event_date)}{ev.location ? ` · ${ev.location}` : ""}</p>
              {ev.description && <p>{ev.description}</p>}
              {ev.url
                ? <a class="cta" href={ev.url} target="_blank" rel="noopener">Details &rarr;</a>
                : <a class="cta" href={`${base}/events`}>See All Events &rarr;</a>}
            </div>
          ))}
        </div>
        <p><a href={`${base}/events`}>View full calendar &rarr;</a></p>
      </section>
    )}

    {featured.length > 0 && (
      <section style="margin-top:2.5rem">
        <h2 class="section-heading"><span class="tri-accent"><img src="/bluetri.svg" alt="" /><img src="/redtri.svg" alt="" /><img src="/yeltri.svg" alt="" /></span> Community Service</h2>
        <div class="card-grid">
          {featured.map((cs) => (
            <div class="card">
              <h3>{cs.title}</h3>
              {cs.service_date && <p class="meta">{fmtDate(cs.service_date)}</p>}
              <div class="prose" set:html={renderMarkdown(cs.description)} />
            </div>
          ))}
        </div>
        <p><a href={`${base}/community-service`}>See all service projects &rarr;</a></p>
      </section>
    )}

    {posts.length > 0 && (
      <section style="margin-top:2.5rem">
        <h2 class="section-heading"><span class="tri-accent"><img src="/bluetri.svg" alt="" /><img src="/redtri.svg" alt="" /><img src="/yeltri.svg" alt="" /></span> From the Blog</h2>
        <div class="card-grid">
          {posts.map((post) => (
            <div class="card">
              <h3><a href={`${base}/blog/${post.slug}`}>{post.title}</a></h3>
              {post.published_at && <p class="meta">{fmtDate(post.published_at)}{post.author ? ` · ${post.author}` : ""}</p>}
              {post.excerpt && <p>{post.excerpt}</p>}
              <a class="cta" href={`${base}/blog/${post.slug}`}>Read more &rarr;</a>
            </div>
          ))}
        </div>
        <p><a href={`${base}/blog`}>All posts &rarr;</a></p>
      </section>
    )}

    <section style="margin-top:2.5rem;background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);border-top:3px solid var(--primary)">
      <h2 class="section-heading"><span class="tri-accent"><img src="/bluetri.svg" alt="" /><img src="/redtri.svg" alt="" /><img src="/yeltri.svg" alt="" /></span> About the Knights of Pythias</h2>
      <p>
        The Knights of Pythias is a non-sectarian fraternal organization founded in 1864 in Washington, D.C.
        by Justus H. Rathbone. It was the first fraternal organization to receive a charter from an Act of Congress.
        Members are united by the ideals of <strong>Friendship, Charity, and Benevolence</strong>.
      </p>
      <p style="margin-top:.75rem"><a href={`${base}/about`}>Learn about our lodge &rarr;</a></p>
    </section>
  </main>
</Base>
