---
import Base from "../../../layouts/Base.astro";
import { getLodgeBySlug, getConfig, getCommunityService } from "../../../lib/db";
import { renderMarkdown } from "../../../lib/markdown";

const lodgeSlug = Astro.params.lodge!;
const db = Astro.locals.runtime.env.DB;

const lodge = await getLodgeBySlug(db, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const config  = await getConfig(db, lodge.id);
const service = await getCommunityService(db, lodge.id, false);

function fmtDate(d: string) {
  return new Date(d + "T00:00:00").toLocaleDateString("en-US", {
    month: "long", day: "numeric", year: "numeric",
  });
}
---

<Base config={config} lodgeSlug={lodgeSlug} title="Community Service">
  <div class="hero">
    <h1>Community Service</h1>
    <p>{config.lodge_name}</p>
  </div>
  <main>
    {service.length === 0
      ? <p style="color:#666">Community service highlights coming soon.</p>
      : (
        <div class="card-grid">
          {service.map((cs) => (
            <div class="card">
              {cs.featured ? <span class="tag">Featured</span> : null}
              <h3>{cs.title}</h3>
              {cs.service_date && <p class="meta">{fmtDate(cs.service_date)}</p>}
              <div class="prose" set:html={renderMarkdown(cs.description)} />
            </div>
          ))}
        </div>
      )
    }
  </main>
</Base>
