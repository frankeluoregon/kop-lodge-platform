---
import AdminForm from "../../../layouts/AdminForm.astro";
import { getAdminToken, isValidAdminToken } from "../../../lib/auth";

const { DB, ADMIN_TOKEN_HASH } = Astro.locals.runtime.env;
const token = getAdminToken(Astro.request);
if (!await isValidAdminToken(token ?? "", ADMIN_TOKEN_HASH ?? "")) {
  return Astro.redirect("/admin/login", 302);
}

let message = "";
let isError = false;

if (Astro.request.method === "POST") {
  try {
    const f = await Astro.request.formData();
    const title = f.get("title")?.toString() ?? "";
    const slug = title.toLowerCase().replace(/[^a-z0-9\s-]/g, "").trim().replace(/\s+/g, "-");
    const publish = f.get("published") === "on";
    const now = new Date().toISOString();
    await DB.prepare(
      `INSERT INTO blog_posts (slug,title,excerpt,content,author,published,published_at,created_at,updated_at)
       VALUES (?,?,?,?,?,?,?,?,?)`
    ).bind(
      slug, title, f.get("excerpt") || null, f.get("content"),
      f.get("author") || null, publish ? 1 : 0,
      publish ? now : null, now, now
    ).run();
    return Astro.redirect("/admin?saved=blog", 302);
  } catch (e: unknown) {
    isError = true;
    message = `Error: ${e instanceof Error ? e.message : String(e)}`;
  }
}
---

<AdminForm title="New Blog Post" backUrl="/admin" backLabel="â† Dashboard">
  {message && <div class={isError ? "error-msg" : "success-msg"}>{message}</div>}
  <form method="POST">
    <div class="field">
      <label>Title *</label>
      <input type="text" name="title" required />
    </div>
    <div class="field">
      <label>Author</label>
      <input type="text" name="author" />
    </div>
    <div class="field">
      <label>Excerpt <span class="hint">(short summary for listings)</span></label>
      <textarea name="excerpt" style="min-height:70px"></textarea>
    </div>
    <div class="field">
      <label>Content * <span class="hint">(Markdown supported)</span></label>
      <textarea name="content" required></textarea>
    </div>
    <div class="field checkbox-row">
      <input type="checkbox" id="published" name="published" />
      <label for="published" style="margin:0;font-weight:400">Publish immediately</label>
    </div>
    <div class="actions">
      <button type="submit" class="btn primary">Create Post</button>
      <a href="/admin" class="btn secondary">Cancel</a>
    </div>
  </form>
</AdminForm>
