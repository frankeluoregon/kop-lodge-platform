---
import { getSession, isSiteAdmin, isAccessConfigured, DEV_SESSION } from "../../../lib/auth";
import { getLodgeById, updateLodge } from "../../../lib/db";
import SiteAdminForm from "../../../layouts/SiteAdminForm.astro";
import LodgeForm from "../../../components/admin/forms/LodgeForm";

const env = Astro.locals.runtime.env;

let session;
if (isAccessConfigured(env)) {
  session = await getSession(Astro.request, env);
  if (!session || !isSiteAdmin(session)) {
    return new Response("Forbidden", { status: 403 });
  }
} else {
  session = DEV_SESSION;
}

const id = Number(Astro.url.searchParams.get("id"));
if (!id) return Astro.redirect("/admin", 302);

let lodge = await getLodgeById(env.DB, id);
if (!lodge) return Astro.redirect("/admin", 302);

const created = Astro.url.searchParams.get("created") === "1";

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();
  const name = (form.get("name") as string || "").trim();
  const number = (form.get("number") as string || "").trim();
  const slug = (form.get("slug") as string || "").trim().toLowerCase().replace(/[^a-z0-9-]/g, "");
  const active = form.get("active") === "on" ? 1 : 0;

  const adminEmails = (form.get("admin_emails") as string || "")
    .split(/[\n,]+/).map(e => e.trim().toLowerCase()).filter(Boolean);

  if (!name || !number || !slug) {
    if (wantsJson) return new Response(JSON.stringify({ error: "Name, number, and slug are required." }), { status: 400, headers: { "Content-Type": "application/json" } });
  } else {
    try {
      await updateLodge(env.DB, id, slug, name, number, active);
      // Replace lodge admin roles: delete old, insert new
      await env.DB.prepare("DELETE FROM admin_roles WHERE role = ?").bind(`lodge:${lodge!.slug}`).run();
      // If slug changed, also delete old slug roles
      if (slug !== lodge!.slug) {
        await env.DB.prepare("DELETE FROM admin_roles WHERE role = ?").bind(`lodge:${slug}`).run();
      }
      const now = new Date().toISOString();
      for (const email of adminEmails) {
        await env.DB.prepare(
          "INSERT OR IGNORE INTO admin_roles (email, role, created_at) VALUES (?, ?, ?)"
        ).bind(email, `lodge:${slug}`, now).run();
      }
      lodge = await getLodgeById(env.DB, id);
      if (wantsJson) return new Response(JSON.stringify({ message: "Lodge updated." }), { headers: { "Content-Type": "application/json" } });
    } catch (e: any) {
      const msg = e.message?.includes("UNIQUE") ? "A lodge with that slug already exists." : `Error: ${e.message}`;
      if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
  }
}

const adminRoles = await env.DB.prepare(
  "SELECT email FROM admin_roles WHERE role = ?"
).bind(`lodge:${lodge!.slug}`).all<{ email: string }>();
const currentAdminEmails = adminRoles.results.map(r => r.email).join("\n");
---

<SiteAdminForm title="Edit Lodge">
  {created && <div class="success-msg">Lodge created successfully!</div>}

  <LodgeForm
    client:only="react"
    isEdit
    initialData={{
      name: lodge!.name,
      number: String(lodge!.number),
      slug: lodge!.slug,
      active: !!lodge!.active,
      admin_emails: currentAdminEmails,
    }}
    viewSiteUrl={lodge!.active ? `/lodges/${lodge!.slug}/` : undefined}
    lodgeAdminUrl={lodge!.active ? `/lodges/admin/${lodge!.slug}` : undefined}
  />
</SiteAdminForm>
