---
import { getSession, isSiteAdmin, isAccessConfigured, DEV_SESSION } from "../../../lib/auth";
import { createLodge } from "../../../lib/db";
import SiteAdminForm from "../../../layouts/SiteAdminForm.astro";
import LodgeForm from "../../../components/admin/forms/LodgeForm";

const env = Astro.locals.runtime.env;

let session;
if (isAccessConfigured(env)) {
  session = await getSession(Astro.request, env);
  if (!session || !isSiteAdmin(session)) {
    return new Response("Forbidden", { status: 403 });
  }
} else {
  session = DEV_SESSION;
}

if (Astro.request.method === "POST") {
  const wantsJson = Astro.request.headers.get("Accept")?.includes("application/json");
  const form = await Astro.request.formData();
  const name = (form.get("name") as string || "").trim();
  const number = (form.get("number") as string || "").trim();
  const slug = (form.get("slug") as string || "").trim().toLowerCase().replace(/[^a-z0-9-]/g, "");

  const adminEmails = (form.get("admin_emails") as string || "")
    .split(/[\n,]+/).map(e => e.trim().toLowerCase()).filter(Boolean);

  const memberNames = (form.get("member_names") as string || "")
    .split(/\n+/).map(e => e.trim()).filter(Boolean);

  if (!name || !number || !slug) {
    if (wantsJson) return new Response(JSON.stringify({ error: "All fields are required." }), { status: 400, headers: { "Content-Type": "application/json" } });
  } else {
    try {
      const id = await createLodge(env.DB, slug, name, number);
      const now = new Date().toISOString();
      for (const email of adminEmails) {
        await env.DB.prepare(
          "INSERT OR IGNORE INTO admin_roles (email, role, created_at) VALUES (?, ?, ?)"
        ).bind(email, `lodge:${slug}`, now).run();
      }
      for (const mname of memberNames) {
        await env.DB.prepare(
          "INSERT INTO lodge_members (lodge_id, name, created_at) VALUES (?, ?, ?)"
        ).bind(id, mname, now).run();
      }
      return wantsJson
        ? Response.redirect(new URL(`/admin/lodges/edit?id=${id}&created=1`, Astro.url), 302)
        : Astro.redirect(`/admin/lodges/edit?id=${id}&created=1`, 302);
    } catch (e: any) {
      const msg = e.message?.includes("UNIQUE") ? "A lodge with that slug already exists." : `Error: ${e.message}`;
      if (wantsJson) return new Response(JSON.stringify({ error: msg }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
  }
}
---

<SiteAdminForm title="Create Lodge">
  <LodgeForm client:only="react" />
</SiteAdminForm>
