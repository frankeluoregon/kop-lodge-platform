---
import AdminForm from "../../../../layouts/AdminForm.astro";
import { getLodgeBySlug } from "../../../../lib/db";

const lodgeSlug = Astro.params.lodge!;
const env = Astro.locals.runtime.env;

const lodge = await getLodgeBySlug(env.DB, lodgeSlug);
if (!lodge) return Astro.redirect("/", 302);

const id = Number(new URL(Astro.request.url).searchParams.get("id"));
if (!id) return Astro.redirect(`/${lodgeSlug}/admin`, 302);

const post = await env.DB.prepare("SELECT * FROM blog_posts WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).first<Record<string, unknown>>();
if (!post) return Astro.redirect(`/${lodgeSlug}/admin`, 302);

let message = "";
let isError = false;

if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  if (form.get("_action") === "delete") {
    await env.DB.prepare("DELETE FROM blog_posts WHERE id = ? AND lodge_id = ?").bind(id, lodge.id).run();
    return Astro.redirect(`/${lodgeSlug}/admin`, 302);
  }
  try {
    const now     = new Date().toISOString();
    const publish = form.get("published") === "1";
    await env.DB.prepare(
      `UPDATE blog_posts SET title=?,slug=?,content=?,excerpt=?,author=?,published=?,published_at=COALESCE(CASE WHEN ? THEN published_at ELSE ? END, ?),updated_at=? WHERE id=? AND lodge_id=?`
    ).bind(
      form.get("title")?.toString() ?? "",
      form.get("slug")?.toString() ?? post.slug,
      form.get("content")?.toString() ?? "",
      form.get("excerpt")?.toString() || null,
      form.get("author")?.toString() || null,
      publish ? 1 : 0,
      !publish, now, publish ? now : null,
      now, id, lodge.id,
    ).run();
    message = "Post updated.";
  } catch (e: unknown) {
    isError = true;
    message = `Error: ${e instanceof Error ? e.message : String(e)}`;
  }
}
---

<AdminForm title="Edit Blog Post" lodgeSlug={lodgeSlug}>
  {message && <div class={isError ? "error-msg" : "success-msg"}>{message}</div>}
  <form method="POST">
    <div class="field">
      <label>Title</label>
      <input type="text" name="title" value={String(post.title ?? "")} required />
    </div>
    <div class="row">
      <div class="field">
        <label>Slug</label>
        <input type="text" name="slug" value={String(post.slug ?? "")} required />
      </div>
      <div class="field">
        <label>Author</label>
        <input type="text" name="author" value={String(post.author ?? "")} />
      </div>
    </div>
    <div class="field">
      <label>Excerpt</label>
      <input type="text" name="excerpt" value={String(post.excerpt ?? "")} />
    </div>
    <div class="field">
      <label>Content <span class="hint">(Markdown)</span></label>
      <textarea name="content" required>{String(post.content ?? "")}</textarea>
    </div>
    <div class="field">
      <label class="checkbox-row">
        <input type="checkbox" name="published" value="1" checked={Boolean(post.published)} /> Published
      </label>
    </div>
    <div class="actions">
      <button type="submit" class="btn primary">Save Changes</button>
      <a href={`/${lodgeSlug}/admin`} class="btn secondary">Cancel</a>
      <button type="submit" name="_action" value="delete" class="btn danger" onclick="return confirm('Delete this post?')">Delete</button>
    </div>
  </form>
</AdminForm>
