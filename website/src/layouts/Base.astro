---
import type { LodgeConfig } from "../lib/db";

interface Props {
  title?: string;
  description?: string;
  config: LodgeConfig;
  lodgeSlug: string;
}

const { title, description, config, lodgeSlug } = Astro.props;
const base = `/lodges/${lodgeSlug}`;
const pageTitle = title
  ? `${title} | ${config.lodge_name}`
  : `${config.lodge_name} – Knights of Pythias`;
const metaDesc = description ?? config.tagline;
const primary = config.primary_color || "#252e67";
const accent = config.accent_color || "#f5a71c";
const secondary = "#a91e23";
const neutral = "#4a5072";

function isActive(path: string): boolean {
  return Astro.url.pathname === path;
}
function isActivePrefix(prefix: string): boolean {
  return Astro.url.pathname.startsWith(prefix);
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={metaDesc} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <style define:vars={{ primary, accent, secondary, neutral }}>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --primary:   var(--primary);
        --accent:    var(--accent);
        --secondary: var(--secondary);
        --neutral:   var(--neutral);
        --text:      #1a1a2e;
        --bg:        #f7f8fc;
        --card-bg:   #ffffff;
        --border:    #dde0eb;
        --radius:    6px;
        --shadow:    0 2px 8px rgba(0,0,0,.08);
        --max-w:     1100px;
        --font:      'Trebuchet MS', Trebuchet, 'Gill Sans MT', Arial, sans-serif;
      }

      body {
        font-family: var(--font); color: var(--text); line-height: 1.7;
        background-image: url('/mainbg.png');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-color: var(--primary);
      }
      a { color: var(--primary); text-decoration: none; }
      a:hover { text-decoration: underline; }

      .tricolor-stripe { display: flex; height: 5px; border-top: 1px solid #000; border-bottom: 1px solid #000; }
      .tricolor-stripe span { flex: 1; }

      .site-banner {
        background: rgba(37,46,103,.88);
        color: rgba(255,255,255,.7);
        font-size: .75rem;
        text-align: center;
        padding: .3rem 1rem;
      }
      .site-banner a { color: var(--accent); font-weight: 600; }

      header { background: rgba(74,80,114,.92); color: #fff; padding: 0 1.5rem; }
      .header-inner {
        max-width: var(--max-w); margin: 0 auto;
        display: flex; align-items: center; justify-content: space-between;
        gap: 1rem; padding: .8rem 0;
      }
      .lodge-brand { display: flex; align-items: center; gap: .75rem; }
      .lodge-brand .header-logo { height: 40px; width: auto; flex-shrink: 0; }
      .lodge-brand .brand-text { display: flex; flex-direction: column; gap: .15rem; }
      .lodge-brand .name { font-size: 1.4rem; font-weight: 700; color: var(--accent); letter-spacing: .04em; text-transform: uppercase; }
      .lodge-brand .sub  { font-size: .78rem; opacity: .88; letter-spacing: .02em; }

      nav { display: flex; gap: .1rem; flex-wrap: wrap; align-items: center; }
      nav a {
        color: #fff; padding: .45rem .8rem; border-radius: var(--radius);
        font-size: .875rem; font-weight: 600; letter-spacing: .02em; transition: background .15s;
      }
      nav a:hover { background: rgba(255,255,255,.18); text-decoration: none; }
      nav a[aria-current="page"] { background: var(--accent); color: var(--primary); }

      .hero {
        position: relative;
        color: #fff; text-align: center; padding: 3.5rem 1.5rem;
      }
      .hero::before {
        content: ''; position: absolute; inset: 0;
        background: linear-gradient(160deg, #252e67 50%, #14193c);
      }
      .hero::after {
        content: ''; display: block; position: absolute; bottom: 0; left: 0; right: 0; height: 4px;
        background: linear-gradient(to right, var(--primary) 33.3%, var(--secondary) 33.3% 66.6%, var(--accent) 66.6%);
      }
      .hero > * { position: relative; }
      .hero h1 { font-size: 2.3rem; color: var(--accent); margin-bottom: .5rem; text-transform: uppercase; letter-spacing: .06em; }
      .hero p  { font-size: 1.05rem; opacity: .92; }

      main {
        max-width: var(--max-w); margin: 2rem auto; padding: 1.5rem;
        background: rgba(247,248,252,0.82);
        border-radius: var(--radius);
        box-shadow: 0 4px 24px rgba(0,0,0,.18);
      }

      .section-heading {
        font-size: 1.45rem; color: var(--primary); text-transform: uppercase;
        letter-spacing: .04em; border-bottom: 3px solid var(--accent); padding-bottom: .35rem; margin-bottom: 1.5rem;
        display: flex; align-items: center; gap: .5rem;
      }
      .tri-accent { display: inline-flex; gap: 3px; flex-shrink: 0; }
      .tri-accent img { height: 14px; width: auto; }

      .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 1.25rem; margin-bottom: 2.5rem; }
      .card {
        background: rgba(255,255,255,0.88); border: 1px solid var(--border); border-top: 3px solid var(--primary);
        border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.25rem; display: flex; flex-direction: column; gap: .5rem;
      }
      .card .tag { display: inline-block; font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: .07em; padding: .2rem .55rem; border-radius: 99px; background: var(--accent); color: var(--primary); }
      .card h3   { font-size: 1.05rem; color: var(--primary); font-weight: 700; }
      .card .meta { font-size: .8rem; color: var(--neutral); }
      .card p    { font-size: .9rem; }
      .card a.cta {
        margin-top: auto; display: inline-block; font-size: .83rem; font-weight: 700;
        color: var(--primary); border: 2px solid var(--primary); border-radius: var(--radius);
        padding: .35rem .85rem; align-self: flex-start; text-transform: uppercase; letter-spacing: .03em;
        transition: background .15s, color .15s;
      }
      .card a.cta:hover { background: var(--primary); color: #fff; text-decoration: none; }

      .prose h1, .prose h2, .prose h3 { color: var(--primary); margin: 1.3rem 0 .5rem; text-transform: uppercase; letter-spacing: .03em; }
      .prose p  { margin-bottom: 1rem; }
      .prose ul { padding-left: 1.5rem; margin-bottom: 1rem; list-style: none; }
      .prose ul li { position: relative; padding-left: 1.2rem; }
      .prose ul li::before {
        content: ''; position: absolute; left: 0; top: .55em;
        width: 10px; height: 9px;
        background: url('/bluetri.svg') no-repeat center/contain;
      }
      .prose a  { color: var(--primary); text-decoration: underline; }
      .prose hr { border: none; border-top: 2px solid var(--accent); margin: 2rem 0; }

      footer { background: var(--primary); color: rgba(255,255,255,.82); text-align: center; padding: 1.5rem; margin-top: 3rem; font-size: .85rem; }
      footer a { color: var(--accent); }
      footer .footer-grid {
        max-width: var(--max-w); margin: 0 auto 1rem;
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 1rem; text-align: left;
      }
      footer h4  { color: var(--accent); margin-bottom: .4rem; font-size: .88rem; text-transform: uppercase; letter-spacing: .05em; }
      footer ul  { list-style: none; }
      footer li  { margin-bottom: .25rem; padding-left: 1rem; position: relative; }
      footer li::before {
        content: ''; position: absolute; left: 0; top: .45em;
        width: 8px; height: 7px;
        background: url('/yeltri.svg') no-repeat center/contain;
      }

      @media (max-width: 640px) {
        .header-inner { flex-direction: column; align-items: flex-start; }
        .hero h1 { font-size: 1.6rem; }
        nav { gap: 0; }
      }
    </style>
  </head>
  <body>
    <div class="tricolor-stripe">
      <span style="background:var(--primary)"></span>
      <span style="background:var(--secondary)"></span>
      <span style="background:var(--accent)"></span>
    </div>
    <div class="site-banner">
      <a href="/">← Oregon Knights of Pythias</a>
    </div>
    <header>
      <div class="header-inner">
        <a href={base} class="lodge-brand" style="text-decoration:none">
          <img src="/seal.svg" alt="KoP Seal" class="header-logo" />
          <div class="brand-text">
            <span class="name">{config.lodge_name}</span>
            <span class="sub">Knights of Pythias{config.lodge_number && config.lodge_number !== "0" ? ` · Lodge No. ${config.lodge_number}` : ""}{config.city ? ` · ${config.city}` : ""}</span>
          </div>
        </a>
        <nav>
          <a href={base} aria-current={isActive(`${base}`) || isActive(`${base}/`) ? "page" : undefined}>Home</a>
          <a href={`${base}/about`} aria-current={isActive(`${base}/about`) ? "page" : undefined}>About</a>
          {config.show_history === "1" && <a href={`${base}/history`} aria-current={isActive(`${base}/history`) ? "page" : undefined}>History</a>}
          {config.show_events !== "" && <a href={`${base}/events`} aria-current={isActivePrefix(`${base}/events`) ? "page" : undefined}>Events</a>}
          {config.show_officers !== "" && <a href={`${base}/officers`} aria-current={isActive(`${base}/officers`) ? "page" : undefined}>Officers</a>}
          {config.show_service !== "" && <a href={`${base}/community-service`} aria-current={isActive(`${base}/community-service`) ? "page" : undefined}>Service</a>}
          {config.show_membership === "1" && <a href={`${base}/membership`} aria-current={isActive(`${base}/membership`) ? "page" : undefined}>Join</a>}
          {config.show_gallery === "1" && <a href={`${base}/gallery`} aria-current={isActive(`${base}/gallery`) ? "page" : undefined}>Gallery</a>}
          {config.show_blog !== "" && <a href={`${base}/blog`} aria-current={isActivePrefix(`${base}/blog`) ? "page" : undefined}>Blog</a>}
          {config.show_newsletter === "1" && <a href={`${base}/newsletter`} aria-current={isActive(`${base}/newsletter`) ? "page" : undefined}>Newsletter</a>}
          {config.show_programs === "1" && <a href={`${base}/programs`} aria-current={isActive(`${base}/programs`) ? "page" : undefined}>Programs</a>}
          {config.show_links === "1" && <a href={`${base}/links`} aria-current={isActive(`${base}/links`) ? "page" : undefined}>Links</a>}
          <a href={`${base}/contact`} aria-current={isActive(`${base}/contact`) ? "page" : undefined}>Contact</a>
        </nav>
      </div>
    </header>

    <slot />

    <footer>
      <div class="footer-grid">
        <div>
          <h4>{config.lodge_name}</h4>
          {config.meeting_schedule && <p>{config.meeting_schedule}</p>}
          {config.meeting_location && <p>{config.meeting_location}</p>}
        </div>
        <div>
          <h4>Quick Links</h4>
          <ul>
            <li><a href={`${base}/about`}>About Us</a></li>
            <li><a href={`${base}/events`}>Events</a></li>
            <li><a href={`${base}/officers`}>Officers</a></li>
            <li><a href={`${base}/contact`}>Contact</a></li>
          </ul>
        </div>
        <div>
          <h4>Connect</h4>
          <ul>
            {config.facebook_url && <li><a href={config.facebook_url} target="_blank" rel="noopener">Facebook</a></li>}
            {config.instagram_url && <li><a href={config.instagram_url} target="_blank" rel="noopener">Instagram</a></li>}
            {config.twitter_url && <li><a href={config.twitter_url} target="_blank" rel="noopener">Twitter / X</a></li>}
            {config.donation_url && <li><a href={config.donation_url} target="_blank" rel="noopener">Donate</a></li>}
            <li><a href="https://www.pythias.org" target="_blank" rel="noopener">Supreme Lodge</a></li>
            {config.grand_lodge_url && <li><a href={config.grand_lodge_url} target="_blank" rel="noopener">Grand Lodge</a></li>}
          </ul>
        </div>
        {config.mailing_address && <div>
          <h4>Mailing Address</h4>
          <p>{config.mailing_address}</p>
        </div>}
      </div>
      <p>
        &copy; {new Date().getFullYear()} {config.lodge_name} &mdash; Knights of Pythias.
        <span style="margin-left:.5rem"><a href={`/lodges/admin/${lodgeSlug}`}>Admin</a></span>
      </p>
    </footer>
  </body>
</html>
